<!DOCTYPE html>

<head>

<style>
    body {
      background-color: #0D0D0D;
      font-family: 'Ubuntu', sans-serif;
    }

    html {
      scroll-behavior: smooth;
    }

    .map {
      background-image: linear-gradient(to bottom, #202120, grey);
      width: 650px;
      height: 450px;
      border-radius: 1.5em;
      box-shadow: 0px 11px 35px 2px rgba(0, 0, 0, 0.14);
      margin-left: 50px;
      margin-top: 50px;
    }

    .stat1 {
      background-image: linear-gradient(to bottom, #202120, grey);
      width: 250px;
      height: 150px;
      border-radius: 1.5em;
      box-shadow: 0px 11px 35px 2px rgba(0, 0, 0, 0.14);
      margin-left: 50px;
      margin-bottom: 20px;
      margin-top: 30px;
    }

    .stat2 {
      background-image: linear-gradient(to bottom, #202120, grey);
      width: 250px;
      height: 150px;
      border-radius: 1.5em;
      box-shadow: 0px 11px 35px 2px rgba(0, 0, 0, 0.14);
      margin-left: 300px;
      margin-bottom: 20px;
      margin-top: 30px;
    }

    .stat3 {
      background-image: linear-gradient(to bottom, #202120, grey);
      width: 250px;
      height: 150px;
      border-radius: 1.5em;
      box-shadow: 0px 11px 35px 2px rgba(0, 0, 0, 0.14);
      margin-left: 300px;
      margin-bottom: 20px;
      margin-top: 30px;
    }

    .mapboxgl-popup {
      max-width: 100px;
      max-height: 400px;
      font: 12px/20px 'Open Sans', sans-serif;
      border-radius: 5px;
    }

    .mapboxgl-popup-content {
      font: 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      font-size: 11;
      color: rgb(0,0,0);
      padding: 0;
      width: 180px;
    }

</style>

<style type="text/css">
    html {
      scroll-behavior: smooth;
    }
    
    /*  
    Side Navigation Menu V2, RWD
    ===================
    Author: @heyPablete

     */

    @charset "UTF-8";
    @import url(https://fonts.googleapis.com/css?family=Open+Sans:300,400,700);

    body {
      font-family: 'Open Sans', sans-serif;
      font-weight: 300;
      line-height: 1.42em;
      color:#A7A1AE;
      /*background-color:#1F2739;*/
    }

    h1 {
      font-size:3em; 
      font-weight: 300;
      line-height:1em;
      text-align: center;
      color: #4DC3FA;
    }

    h2 {
      font-size:1em; 
      font-weight: 300;
      text-align: center;
      display: block;
      line-height:1em;
      padding-bottom: 2em;
      color: #FB667A;
    }

    h2 a {
      font-weight: 700;
      text-transform: uppercase;
      color: #FB667A;
      text-decoration: none;
    }

    .blue { color: #185875; }
    .yellow { color: #FFF842; }

    .container th h1 {
          font-weight: bold;
          font-size: 1em;
      text-align: left;
      color: #185875;
    }

    .container td {
          font-weight: normal;
          font-size: 1em;
      -webkit-box-shadow: 0 2px 2px -2px #0E1119;
           -moz-box-shadow: 0 2px 2px -2px #0E1119;
                box-shadow: 0 2px 2px -2px #0E1119;
    }

    .container {
          text-align: left;
          overflow: hidden;
          width: 80%;
          margin: 0 auto;
      display: table;
      padding: 0 0 8em 0;
    }

    .container td, .container th {
          padding-bottom: 2%;
          padding-top: 2%;
      padding-left:2%;  
    }

    /* Background-color of the odd rows */
    .container tr:nth-child(odd) {
          background-color: #323C50;
    }

    /* Background-color of the even rows */
    .container tr:nth-child(even) {
          background-color: #2C3446;
    }

    .container th {
          background-color: #1F2739;
    }

    .container td:first-child { color: #FB667A; }

    .container tr:hover {
       background-color: #464A52;
    -webkit-box-shadow: 0 6px 6px -6px #0E1119;
           -moz-box-shadow: 0 6px 6px -6px #0E1119;
                box-shadow: 0 6px 6px -6px #0E1119;
    }

    .container td:hover {
      background-color: #FFF842;
      color: #403E10;
      font-weight: bold;
      
      box-shadow: #7F7C21 -1px 1px, #7F7C21 -2px 2px, #7F7C21 -3px 3px, #7F7C21 -4px 4px, #7F7C21 -5px 5px, #7F7C21 -6px 6px;
      transform: translate3d(6px, -6px, 0);
      
      transition-delay: 0s;
          transition-duration: 0.4s;
          transition-property: all;
      transition-timing-function: line;
    }

    @media (max-width: 800px) {
    .container td:nth-child(4),
    .container th:nth-child(4) { display: none; }
    }
</style>

<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />

<title>Smart Bin - Home</title>
</head>


<body>

    <h1 style="color: #38BB36; text-align: center; font-family: 'Ubuntu', sans-serif; ">SMART-BIN</h1>

    <div class="map", id="map", style="width:650px;height:450px;">

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWFuZzAwMDIiLCJhIjoiY2tldmdmamttMXk3ZzJ4bXJseGt4cDBybyJ9.FPvgW8PxjOUeEV33WTfABg';
        var myLatitude = -37.809967
        var myLongitude = 144.962640
        var binsToGet;
        // if ("geolocation" in navigator) { 
        //     navigator.geolocation.getCurrentPosition(position => { 
        //         console.log(position.coords.latitude, position.coords.longitude); 
        //         myLatitude = position.coords.latitude;
        //         myLongitude = position.coords.longitude;
        //     }); 
        // } 
        // else { 
        //     console.log("Default position will be used")
        // }
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v10',
            center: [myLongitude, myLatitude], // starting position
            zoom: 14
        });

        // initialize the map canvas to interact with later
        var canvas = map.getCanvasContainer();

        map.on('load', function() {
            //getRoute([myLongitude, myLatitude], [144.962640, -37.909967]);

            // Add starting point to the map
            var marker = new mapboxgl.Marker()
                .setLngLat([myLongitude, myLatitude])
                .addTo(map);

            // add bin markers to the map
            var request = new XMLHttpRequest()
            binsToGet = 5;
            var path = 'http://127.0.0.1:8000/getbins/'

            request.open('GET', path, true)
            request.onload = function () {
              // Begin accessing JSON data here
              var data = JSON.parse(this.response).data

              // store the bins data to local storage
              window.localStorage.setItem('bins', JSON.stringify(data));

              if (request.status >= 200 && request.status < 400) {
                data.forEach((bin) => {
                    // draw the bin on the map
                    var binPos = [parseFloat(bin.attributes.bin_longitude), parseFloat(bin.attributes.bin_latitude)]
                    var binFullness = parseInt(bin.attributes.bin_fullness)
                    let binColor;
                    // green
                    if (binFullness>=0 && binFullness<=24){ binColor = 'green';}
                    // yellow
                    else if (binFullness>=25 && binFullness<=49){ binColor = 'yellow';}
                    // orange
                    else if (binFullness>=50 && binFullness<=74){ binColor = 'orange';}
                    // red
                    else{ binColor = 'red';}
                    let bin_text =  "<p>" +
                                    "Bin Num: " + bin.attributes.bin_num + "<br>" +
                                    "Fullness: " + bin.attributes.bin_fullness + "<br>" +
                                    "Bin Type: " + bin.attributes.bin_type +
                                    "</p>"
                    let popup = new mapboxgl.Popup()
                              .setHTML(bin_text)
                              .addTo(map);
                    let binMarker = new mapboxgl.Marker({color: binColor})
                                    .setPopup(popup)
                                    .setLngLat(binPos)
                                    .addTo(map);
                })
              } else {
                console.log('error')
              }
            }

            request.send()
        });

        // // Create a popup, but don't add it to the map yet.
        // var popup = new mapboxgl.Popup({
        //   closeButton: false,
        //   closeOnClick: false
        // });

        // map.on('mouseenter', 'places', function (e) {
        //   // Change the cursor style as a UI indicator.
        //   map.getCanvas().style.cursor = 'pointer';
           
        //   var coordinates = e.features[0].geometry.coordinates.slice();
        //   var description = e.features[0].properties.description;
           
        //   // Ensure that if the map is zoomed out such that multiple
        //   // copies of the feature are visible, the popup appears
        //   // over the copy being pointed to.
        //   while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        //   coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        //   }
           
        //   // Populate the popup and set its coordinates
        //   // based on the feature found.
        //   popup.setLngLat(coordinates).setHTML(description).addTo(map);
        //   });
           
        //   map.on('mouseleave', 'places', function () {
        //     map.getCanvas().style.cursor = '';
        //     popup.remove();
        // });
    </script>
    </div>

    <br>
    <table class="container" id="binTable"></table>

    <script type="text/javascript">
        /*
        Create a table dynamically
        */
        function generateTableHead(table, headers) {
            let thead = table.createTHead();
            let row = thead.insertRow();
            headers.forEach((header) => {
                let th = document.createElement("th");
                let text = document.createTextNode(header);
                th.appendChild(text);
                row.appendChild(th);
                })
        }

        function generateTableContent(table, attributes) {
            let request = new XMLHttpRequest()
            let path = 'http://127.0.0.1:8000/nearestbins/' + myLatitude + '/' + myLongitude + '/' + binsToGet
            
            request.open('GET', path, true)
            request.onload = function () {
              // Begin accessing JSON data here
              var data = JSON.parse(this.response).data

              if (request.status >= 200 && request.status < 400) {
                // store data into local storage
                // display the 5 nearest bin entries in the HTML table
                data.forEach((bin) => {
                    // render a row in the table
                    let row = table.insertRow();
                    attributes.forEach((key) => {
                        let cell = row.insertCell();
                        let content = document.createTextNode(bin.attributes[key])
                        cell.appendChild(content);
                    })
                    let cell = row.insertCell();
                    let button = document.createElement("BUTTON");
                    button.innerHTML = "GET DIRECTION";
                    button.onclick = function (){
                        let start_pos = [myLongitude, myLatitude]
                        let target_pos = [bin.attributes['bin_longitude'], bin.attributes['bin_latitude']]
                        getRoute(start_pos, target_pos);
                        window.scrollTo(0,0);
                    }
                    cell.appendChild(button)
                })}
              else {
                console.log('error');
              }
            }

            request.send();
        }

        function getRoute(start, end) {
            // https://www.mapbox.com/api-documentation/#directions
            var url = 'https://api.mapbox.com/directions/v5/mapbox/walking/' + start[0] + ',' + start[1] + ';' + end[0] + ',' + end[1] + '?steps=true&geometries=geojson&access_token=' + mapboxgl.accessToken;
            var req = new XMLHttpRequest();
            req.responseType = 'json';
            req.open('GET', url, true);
            req.onload  = function() {
              var jsonResponse = req.response;
              var distance = jsonResponse.routes[0].distance*0.001; // convert to km
              var duration = jsonResponse.routes[0].duration/60; // convert to minutes
              var coords = jsonResponse.routes[0].geometry;
              // add the route to the map
              addRoute(coords);
            };
            req.send();
        }

        // adds the route as a layer on the map
        function addRoute (coords) {
          // check if the route is already loaded
          if (map.getSource('route')) {
            map.removeLayer('route')
            map.removeSource('route')
          } else{
            map.addLayer({
              "id": "route",
              "type": "line",
              "source": {
                "type": "geojson",
                "data": {
                  "type": "Feature",
                  "properties": {},
                  "geometry": coords
                }
              },
              "layout": {
                "line-join": "round",
                "line-cap": "round"
              },
              "paint": {
                "line-color": "#3b9ddd",
                "line-width": 6,
                "line-opacity": 0.8
              }
            });
          };
        }

        let headers = ["Bin Num", "Type", "Fullness", "Last Cleared", "Status"]
        let attributes = ["bin_num", "bin_type", "bin_fullness", "last_cleared_datetime", "bin_status"]
        let table = document.getElementById("binTable");
        generateTableHead(table, headers);
        generateTableContent(table, attributes);
    </script>

</body>




</html>

